<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="I’d recently lookup up IntersectionObserver for some other project and I thought to my self I wanted to make something with it. Lazy loading images was the first thing that got to my mind and that was">
<meta name="keywords" content="hexo,lazyload,image,disqus">
<meta property="og:type" content="article">
<meta property="og:title" content="Lazy loading images and disqus in Hexo">
<meta property="og:url" content="http://mollwe.se/2017/12/15/hexo-lazy/index.html">
<meta property="og:site_name" content="Adam Ydenius">
<meta property="og:description" content="I’d recently lookup up IntersectionObserver for some other project and I thought to my self I wanted to make something with it. Lazy loading images was the first thing that got to my mind and that was">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://mollwe.se/images/logo-512.png">
<meta property="og:updated_time" content="2017-12-15T03:28:44.731Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lazy loading images and disqus in Hexo">
<meta name="twitter:description" content="I’d recently lookup up IntersectionObserver for some other project and I thought to my self I wanted to make something with it. Lazy loading images was the first thing that got to my mind and that was">
<meta name="twitter:image" content="http://mollwe.se/images/logo-512.png">
    
    
        
          
    <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
    <link rel="icon" type="image/png" href="/images/android-chrome-192x192.png" sizes="192x192">
          
        
        
          
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Lazy loading images and disqus in Hexo</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
    <link rel="alternate" href="/atom.xml" title="Adam Ydenius" type="application/atom+xml" />
    
</head>

<body>
    <header id="header">
  <a href="/">
  
    
      <div id="logo" style="background-image: url(/images/logo-50.png);"></div>
    
  
    <div id="title">
      <h1>Adam Ydenius </h1>
      <small>...has no time for this</small>
    </div>
  </a>
  <div id="nav">
    <ul>
       
        <li><a href="/">Home</a></li>
       
        <li><a href="/archives/">Logs</a></li>
       
        <li><a href="/codex-vitae/">Codex Vitae</a></li>
      
    </ul>
  </div>
</header>

    
    <main>
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Lazy loading images and disqus in Hexo
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Adam Ydenius</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-12-15T01:28:28.000Z" itemprop="datePublished">2017-12-15</time>
    </div>


      
    <div class="article-tag">
        <a class="tag-link" href="/tags/disqus/">disqus</a>, <a class="tag-link" href="/tags/hexo/">hexo</a>, <a class="tag-link" href="/tags/image/">image</a>, <a class="tag-link" href="/tags/lazyload/">lazyload</a>
    </div>


    </div>
  </header>
  <div class="content" itemprop="articleBody">
    <p>I’d recently lookup up <code>IntersectionObserver</code> for some other project and I thought to my self I wanted to make something with it. Lazy loading images was the first thing that got to my mind and that was something I wanted for my site as well. I’ve been working at getting my site as light as possible and I’ve wished I could defer loading of content below the fold earlier. I had found a hexo plugin for lazy loading images but it wasn’t enough for me.</p>
<a id="more"></a>
<h2 id="Rendering"><a href="#Rendering" class="headerlink" title="Rendering"></a>Rendering</h2><p>For the moment I haven’t made a plugin, instead I use a script directly under my custom theme. It hooks up to the <code>after_render</code> of hexo and replaces <em>img</em> tags with some fancy html and then injects a <em>script</em> tag for loading of images as the user scrolls down.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">hexo.extend.filter.register(<span class="string">'after_render:html'</span>, imageLazyLoadProcess);</span><br></pre></td></tr></table></figure>
<p>I’ve put some extra effort into how the image is displayed until loaded. The image placeholder should have the same size and ratio even when not loaded and independent of screen width. By using <em>padding-top</em> as result of <code>height / width * 100</code> and <em>height</em> 0 (inspired from <a href="http://andyshora.com/css-image-container-padding-hack.html" target="_blank" rel="noopener">here</a>) we can maintain ratio. I also needed to add a containing div and set the width so the placeholder can’t become larger than it should.</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">img</span> &#123;</span><br><span class="line">    <span class="attribute">max-width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">height</span>: auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.img-container</span> &#123;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">max-width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.img-container</span> <span class="selector-tag">img</span><span class="selector-pseudo">:not(</span><span class="selector-attr">[src]</span>) &#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"img-container"</span> <span class="attr">style</span>=<span class="string">"width:647px;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">data-src</span>=<span class="string">"/2017/11/27/hello-hexo/build-configuration.png"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">title</span>=<span class="string">"Build configuration"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">height</span>=<span class="string">"644"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">width</span>=<span class="string">"647"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">style</span>=<span class="string">"padding-top:99.53632148377125%;background:linear-gradient(rgba(98,159,207,1.0),rgba(248,248,248,1.0),rgba(249,249,249,1.0),rgba(246,246,246,1.0),rgba(246,246,246,1.0),rgba(249,248,248,1.0),rgba(252,249,249,1.0),rgba(246,245,245,1.0),rgba(249,249,249,1.0),rgba(220,232,243,1.0));"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Even prepends with a <code>&lt;noscript&gt;</code>-extra so it works without javascript with images anyway.</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">noscript</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/2017/11/27/hello-hexo/build-configuration.png"</span> <span class="attr">title</span>=<span class="string">"Build configuration"</span> <span class="attr">height</span>=<span class="string">"644"</span> <span class="attr">width</span>=<span class="string">"647"</span> <span class="attr">noscript</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">noscript</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">noscript</span>&gt;</span><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"><span class="selector-class">.img-container</span> &#123; <span class="attribute">display</span>: none <span class="meta">!important</span>; &#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">noscript</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Before the image has loaded the placeholder is an gradient of the image that is loading. It’s generated by the npm package <em>image-to-gradient</em> (<a href="https://www.npmjs.com/package/image-to-gradient" target="_blank" rel="noopener">npm</a>). However, it’s broken at the time of writing this. I’ve sent a <a href="https://github.com/peterekepeter/image-to-gradient/pull/1" target="_blank" rel="noopener">pull request</a> but you could use my git repo in the meanwhile. </p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">npm install git+https://github.com/mollwe/image-to-gradient.git</span><br></pre></td></tr></table></figure>
<p>I was inspired by <a href="https://medium.freecodecamp.org/using-svg-as-placeholders-more-image-loading-techniques-bed1b810ab2c" target="_blank" rel="noopener">José M. Pérez post about SVG placeholders</a> and I tried out <em>node-potrace</em> but I decided to go for gradients instead because they have smaller footprint and is simpler. The images should load fast so we won’t be seeing much of the placeholders anyways.</p>
<p>If you want the whole scripts file, it’s <a href="/assets/imageLazyLoadRender.js">here</a>.</p>
<h2 id="Loading"><a href="#Loading" class="headerlink" title="Loading"></a>Loading</h2><p>The lazy loading script checks wether the image is visible and then triggers loading of image. The detection is made by <code>IntersectionObserver</code> if supported else it falls back to <code>getBoundingClientRect</code> and event listeners for scroll and resize.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">imageLazyLoad</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> elements = <span class="built_in">document</span>.querySelectorAll(<span class="string">'img[data-src]'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!elements.length) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> IntersectionObserver !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> observer = <span class="keyword">new</span> IntersectionObserver(<span class="function"><span class="keyword">function</span> (<span class="params">entries, observer</span>) </span>&#123;</span><br><span class="line">            entries.filter(<span class="function"><span class="keyword">function</span> (<span class="params">entry</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> entry.isIntersecting;</span><br><span class="line">            &#125;).forEach(<span class="function"><span class="keyword">function</span> (<span class="params">entry</span>) </span>&#123;</span><br><span class="line">                loadImage(entry.target);</span><br><span class="line">                observer.unobserve(entry.target);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        elements.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">element</span>) </span>&#123;</span><br><span class="line">            observer.observe(element);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> timeout;</span><br><span class="line">        <span class="keyword">var</span> verify = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            clearTimeout(timeout);</span><br><span class="line">            timeout = setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                elements = elements.filter(<span class="function"><span class="keyword">function</span> (<span class="params">element</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> !element.src;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!elements.length) &#123;</span><br><span class="line">                    <span class="built_in">window</span>.removeEventListener(<span class="string">'scroll'</span>, verify);</span><br><span class="line">                    <span class="built_in">window</span>.removeEventListener(<span class="string">'resize'</span>, verify);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                elements.filter(<span class="function"><span class="keyword">function</span> (<span class="params">element</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">var</span> position = element.getBoundingClientRect().top;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (position &lt; <span class="built_in">window</span>.innerHeight) &#123;</span><br><span class="line">                        loadImage(element);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;, <span class="number">50</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">window</span>.addEventListener(<span class="string">'scroll'</span>, verify);</span><br><span class="line">        <span class="built_in">window</span>.addEventListener(<span class="string">'resize'</span>, verify);</span><br><span class="line"></span><br><span class="line">        verify();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>To get a nicer effect I add blur to the image and a transition which removes it when image is loaded.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadImage</span>(<span class="params">element</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> src = element.getAttribute(<span class="string">'data-src'</span>);</span><br><span class="line"></span><br><span class="line">    element.style.filter = <span class="string">'blur(10px)'</span>;</span><br><span class="line">    element.style.transition = <span class="string">'filter .1s ease-in-out'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> img = <span class="keyword">new</span> Image();</span><br><span class="line"></span><br><span class="line">    img.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        element.setAttribute(<span class="string">'src'</span>, src);</span><br><span class="line">        element.style.paddingTop = <span class="string">''</span>;</span><br><span class="line">        element.style.height = <span class="string">''</span>;</span><br><span class="line">        element.style.filter = <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    img.src = src;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You can get the full script <a href="/assets/imageLazyLoad.js">here</a></p>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p><noscript><img src="/images/logo-512.png" alt="" height="512" width="512" noscript></noscript><div class="img-container" style="width:512px;"><img data-src="/images/logo-512.png" alt="" height="512" width="512" style="padding-top:100%;background:linear-gradient(rgba(97,95,78,1.0),rgba(108,103,85,1.0),rgba(113,106,87,1.0),rgba(85,76,59,1.0),rgba(104,95,75,1.0),rgba(105,96,75,1.0),rgba(91,82,64,1.0),rgba(81,72,55,1.0),rgba(79,71,54,1.0),rgba(84,90,81,1.0))"></div></p>
<p>Maybe not the best image to demo but you get the idea.</p>
<script>
    var element;

    function init(){
        element = document.querySelector('img[data-src="/images/logo-512.png"]');

        if(element){
            roll();
        }
    }

    function roll() {
        setTimeout(function(){
            if(!element.hasAttribute('src')) {
                roll();
            }
            else {
                element.style.paddingTop = '100%'
                element.style.height = '0';
                element.removeAttribute('src');
                element.style.filter = 'blur(10px)';
                element.style.transition = 'filter .1s ease-in-out'

                setTimeout(function(){
                    var src = element.getAttribute('data-src');
                    element.setAttribute('src', src);
                    element.style.paddingTop = '';
                    element.style.height = '';
                    element.style.filter = '';

                    roll();
                }, 1000);
            }
        }, 5000);
    }

    document.addEventListener('DOMContentLoaded', init, false);
</script>

<h2 id="Lazy-Disqus"><a href="#Lazy-Disqus" class="headerlink" title="Lazy Disqus"></a>Lazy Disqus</h2><p>I felt it was unnecessary to load comments directly not even knowing if the user would ever scroll down to the comment section. So I added a similar script for <a href="https://disqus.com" target="_blank" rel="noopener">Disqus</a> as well.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> IntersectionObserver !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> observer = <span class="keyword">new</span> IntersectionObserver(<span class="function"><span class="keyword">function</span> (<span class="params">entries, observer</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> intersectingEntries = entries.filter(<span class="function"><span class="keyword">function</span> (<span class="params">entry</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> entry.isIntersecting;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (intersectingEntries.length) &#123;</span><br><span class="line">            embedDisqus(shortname);</span><br><span class="line">            observer.disconnect();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    observer.observe(element);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> timeout;</span><br><span class="line">    <span class="keyword">var</span> verify = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        clearTimeout(timeout);</span><br><span class="line">        timeout = setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> position = element.getBoundingClientRect().top;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (position &lt; <span class="built_in">window</span>.innerHeight) &#123;</span><br><span class="line">                embedDisqus(shortname);</span><br><span class="line">                <span class="built_in">window</span>.removeEventListener(<span class="string">'scroll'</span>, verify);</span><br><span class="line">                <span class="built_in">window</span>.removeEventListener(<span class="string">'resize'</span>, verify);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">50</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'scroll'</span>, verify);</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'resize'</span>, verify);</span><br><span class="line"></span><br><span class="line">    verify();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Embedding is simply done by adding a script tag for <em>embed.js</em>.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">embedDisqus</span>(<span class="params">shortname</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span><br><span class="line">    script.src = <span class="string">'https://'</span> + shortname + <span class="string">'.disqus.com/embed.js'</span>;</span><br><span class="line">    script.async = <span class="literal">true</span>;</span><br><span class="line">    script.setAttribute(<span class="string">'data-timestamp'</span>, +<span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(script);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You’ll need to call it like below to trigger it.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">disqusLazyLoad(<span class="string">'mollwe'</span>);</span><br></pre></td></tr></table></figure>
<p>The full script can be downloaded <a href="/assets/disqusLazyLoad.js">here</a>.</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>
    </div>


<script type="text/javascript" src="/js/imageLazyLoad.js"></script><noscript><style>.img-container { display: none !important; }</style></noscript>
    </main>
    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 Adam Ydenius
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Logs</a></li>
         
          <li><a href="/codex-vitae/">Codex Vitae</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    

    <!-- Google Analytics -->
    <script type="text/javascript">
        if (!({ "yes": true, "1": true }[navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack] || false)) {
            (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-6876801-1', 'auto');
            ga('send', 'pageview');
        }
    </script>


    <!-- Disqus Comments -->
    <script src="/js/disqusLazyLoad.js"></script>
    <script type="text/javascript">
        if(typeof disqusLazyLoad === 'function')
            disqusLazyLoad('mollwe');
    </script>


</body>
</html>
